@page "/order_detail/{id:int}"
@rendermode InteractiveServer

<EditForm Model="order" OnValidSubmit="HandleValidSubmit">
    <div class="mb-2">
        <label>Mã phiếu</label>
        <InputText @bind-Value="order.IdOrder" class="form-control" />
    </div>

    <div class="mb-2">
        <label>Tên khách hàng</label>
        <InputText @bind-Value="order.CustomerName" class="form-control" />
    </div>
        <div class="mb-2">
        <label>SĐT</label>
        <InputText @bind-Value="order.CustomerName" class="form-control" />
    </div>
            <div class="mb-2">
        <label>Địa chỉ</label>
        <InputText @bind-Value="order.CustomerName" class="form-control" />
    </div>

    <div class="mb-2">
        <label>Tên dịch vụ</label>
        <InputSelect @bind-Value="order.ServiceId" class="form-control" TValue="string">
            <option value="">-- Chọn dịch vụ --</option>
            <option value="1">Dịch vụ 1</option>
            <option value="2">Dịch vụ 2</option>
        </InputSelect>
    </div>

    <div class="mb-2">
        <label>Tên kỹ thuật viên</label>
        <InputSelect @bind-Value="order.TechnicianId" class="form-control" TValue="string">
            <option value="">-- Chọn kỹ thuật viên --</option>
            <option value="1">Nguyễn Văn A</option>
            <option value="2">Trần Văn B</option>
        </InputSelect>
    </div>

    <div class="mb-2">
        <label>Trạng thái</label>
        <InputSelect @bind-Value="order.Status" class="form-control" TValue="string">
            <option value="pending">Chờ xử lý</option>
            <option value="inprogress">Đang xử lý</option>
            <option value="done">Hoàn thành</option>
        </InputSelect>
    </div>

    <div class="mb-2">
        <label>Thời gian hẹn</label>
        <InputDate @bind-Value="order.AppointmentTime" class="form-control" />
    </div>

    <div class="mb-2">
        <label>Ngày tạo</label>
        <InputDate @bind-Value="order.CreatedDate" class="form-control" disabled />
    </div>

    <div class="mb-2">
        <label>Ngày cập nhật</label>
        <InputDate @bind-Value="order.UpdatedDate" class="form-control" disabled />
    </div>

    <h5 class="mt-3">Danh sách mặt hàng</h5>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>STT</th>
                <th>Tên mặt hàng</th>
                <th>Số lượng</th>
                <th>Đơn vị</th>
                <th>Đơn giá</th>
                <th>Tổng tiền</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in orderProductItems)
            {
                <tr>
                    <td>@(orderProductItems.IndexOf(item) + 1)</td>
                    <td><p>@item.Name</p></td>
                    <td>
                       <input type="number" min=1 class="form-control" value="@item.Quantity" @onchange="(e) => OnQuantityChanged(item, e)" />
                    </td>
                     <td><p>@item.Unit</p></td>
                     <td><p>@item.Price</p></td>
               <td><p>@(item.Quantity * item.Price)</p></td>

                </tr>
            }
        </tbody>
    </table>

    <div class="mt-2">
        <strong>Tổng tiền: @order.Items.Sum(i => i.Quantity * i.Price)</strong>
    </div>

    <button type="submit" class="btn btn-primary mt-3">Lưu phiếu</button>
</EditForm>
<div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
    <table class="table table-striped table-bordered table-hover">
        <thead class="table-dark">
            <tr>
                <th>Mã hàng</th>
                <th>Tên hàng</th>
                <th>Đơn vị</th>
                <th>Số lượng tồn</th>
                <th>Đơn giá</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
@for (int i = 1; i <= 100; i++)
{
    var index = i; <!-- biến tạm -->
    <tr>
        <td>@index</td>
        <td>Mặt hàng @index</td>
        <td>Cái</td>
        <td>@(10 + index)</td>
        <td>@(1000 * index) đ</td>
        <td>
            <button class="btn btn-sm btn-primary"
                    @onclick="@(() => AddItem(index, $"Mặt hàng {index}", "Cái", 1, 1000 * index))">
                +
            </button>
        </td>
    </tr>
}
        </tbody>
    </table>
</div>


@code {
    [Parameter] public int id { get; set; }

    private OrderModel order = new();

    private List<OrderProductModel> orderProductItems = new();
    private void HandleValidSubmit()
    {

        
    }
 private void AddItem(int id, string name, string unit, int quantity, int price)
    {
        orderProductItems.Add(new OrderProductModel
        {
            IdProduct = id,
            Name = name,
            Unit = unit,
            Quantity = quantity,
            Price = price
        });
        Console.WriteLine($"Đã thêm sản phẩm: {name},{unit},{quantity},{price}");
    }
private void OnQuantityChanged(OrderProductModel item, ChangeEventArgs e)
{
    if (int.TryParse(e.Value?.ToString(), out int newQuantity))
    {
        item.Quantity = newQuantity < 1 ? 1 : newQuantity;

        Console.WriteLine($"Số lượng {item.Name} thay đổi thành: {item.Quantity}");
    }
}

    public class OrderModel
    {
        public string IdOrder { get; set; } = "";
        public string CustomerName { get; set; } = "";
        public string ServiceId { get; set; } = "";
        public string TechnicianId { get; set; } = "";
        public string Status { get; set; } = "pending";
        public DateTime AppointmentTime { get; set; } = DateTime.Now;
        public DateTime CreatedDate { get; set; } = DateTime.Now;
        public DateTime? UpdatedDate { get; set; }
        public List<OrderProductModel> Items { get; set; } = new();
    }
    
    public class OrderProductModel
    {
        public int IdProduct { get; set; } = 0;
        public string Name { get; set; } = "";
        public string Unit { get; set; } = "";
        public int Quantity { get; set; } = 1;
        public int Price { get; set; } = 0;
    }
}