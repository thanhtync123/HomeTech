@page "/orders/create"
@page "/order_detail/{id:int}"
@rendermode InteractiveServer
@using HomeTechBlazor.Model
@inject OrderDetailService orderDetailService

@if(id == 0)
{
	<div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
		<table class="table table-striped table-bordered table-hover">
			<tr>
				<th>ID</th>
				<th>Họ tên</th>
				<th>Địa chỉ</th>
				<th>SĐT</th>
			</tr>
			@foreach (var item in customerList)
			{
				<tr @onclick="() => cellClickTBCustomer(item)">
					<td>@item.Id</td>
					<td>@item.Name</td>
					<td>@item.Address</td>
					<td>@item.Phone</td>
				</tr>
			}

		</table>
	</div>
}



<EditForm Model="order" OnValidSubmit="HandleValidSubmit">
	<DataAnnotationsValidator />
	<div class="mb-2">
		<label>Mã phiếu</label>
		<InputNumber @bind-Value="order.IdOrder" class="form-control" readonly />
		<ValidationMessage For="@(() => order.IdOrder)" />
	</div>
	<div class="mb-2">
		<label>Mã khách hàng</label>
		<InputNumber @bind-Value="order.IdCustomer" class="form-control" readonly />
		<ValidationMessage For="@(() => order.IdCustomer)" />
	</div>
	<div class="mb-2">
		<label>Tên khách hàng</label>
		<InputText @bind-Value="order.CustomerName" class="form-control" readonly />
		<ValidationMessage For="@(() => order.CustomerName)" />
	</div>
	<div class="mb-2">
		<label>SĐT</label>
		<InputText @bind-Value="order.Phone" class="form-control" readonly />
		<ValidationMessage For="@(() => order.Phone)" />
	</div>
	<div class="mb-2">
		<label>Địa chỉ</label>
		<InputText @bind-Value="order.Address" class="form-control" readonly />
		<ValidationMessage For="@(() => order.Address)" />
	</div>

	<div class="mb-2">
		<label>Tên dịch vụ</label>
		<InputSelect @bind-Value="order.ServiceId" @bind-Value:after="LoadTotalPrice" class="form-control" TValue="int">
			<option value="0">-- Chọn dịch vụ --</option>
			@foreach (var kv in serviceDict)
			{
				<option value="@kv.Key">@kv.Value.Item1:@kv.Value.Item2.ToString("N0")</option>
			}
			<ValidationMessage For="@(() => order.ServiceId)" />
		</InputSelect>


	</div>

	<div class="mb-2">
		<label>Tên kỹ thuật viên</label>
		<InputSelect @bind-Value="order.TechnicianId" class="form-control" TValue="int">
			<option value="0">-- Chọn kỹ thuật viên --</option>
			@foreach (var kv in technicalDict)
			{
				<option value="@kv.Key">@kv.Value</option>
			}
			<ValidationMessage For="@(() => order.TechnicianId)" />
		</InputSelect>
	</div>

	<div class="mb-2">
		<label>Trạng thái</label>
		<InputSelect @bind-Value="order.Status" class="form-control" TValue="string">
			<option value="pending">Chờ xử lý</option>
			<option value="completed">Hoàn thành</option>
			<option value="cancelled">Đã hủy</option>
		</InputSelect>
	</div>

	<div class="mb-2">
		<label>Thời gian hẹn</label>
		<InputDate @bind-Value="order.AppointmentTime" class="form-control" />
	</div>

	<p>Ngày tạo đơn: @order.CreatedDate</p>
	<p>Ngày cập nhật: @order.UpdatedDate</p>

	<h5 class="mt-3">Danh sách mặt hàng</h5>
	<table class="table table-bordered">
		<thead>
			<tr>
				<th>Mã hàng</th>
				<th>Tên mặt hàng</th>
				<th>Số lượng</th>
				<th>Đơn vị</th>
				<th>Đơn giá</th>
				<th>Tổng tiền</th>
				<th>Xóa</th>
			</tr>
		</thead>
		<tbody>

			@foreach (var item in equipmentOrderList)
			{
				<tr>
					<td>@item.IdProduct</td>
					<td><p>@item.Name</p></td>
					<td>
						<input type="number" min=1 class="form-control" value="@item.Quantity" @onchange="(e) => OnQuantityChanged(item, e)" />
					</td>
					<td><p>@item.Unit</p></td>
					<td><p>@item.Price.ToString("N0")</p></td>
					<td>
						<p>@( (item.Quantity * item.Price).ToString("N0") )</p>
					</td>
					<td>
						<button class="btn btn-sm btn-primary"
								@onclick="(() => RemoveItem(item.IdProduct))">
							-
						</button>
					</td>
				</tr>
			}
		</tbody>
	</table>

	<div class="mt-2">
		<strong>
			<p>
				Phí dịch vụ:
				@servicePrice
			</p>
		</strong>
		<strong>Tiền sản phẩm: @equipsPrice.ToString("N0")</strong>
		<strong>Tổng cộng: @totalprice.ToString("N0")</strong>

	</div>

	@if (id == 0)
	{
		<button type="submit" disabled="@(!isDisableButtonSubmit)" class="btn btn-primary mt-3">Tạo mới</button>
	}
	else
	{
		<button type="submit" class="btn btn-primary mt-3">Lưu phiếu</button>
	}

</EditForm>
<input @bind-value="keyword"
	   @bind-value:event="oninput"
	   @onkeyup="async () => await LoadEquipmentTable()"
	   class="form-control" placeholder="Tìm kiếm..." />


<div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
	<table class="table table-striped table-bordered table-hover">
		<thead class="table-dark">
			<tr>
				<th>Mã hàng</th>
				<th>Tên hàng</th>
				<th>Đơn vị</th>
				<th>Số lượng tồn</th>
				<th>Đơn giá</th>
				<th>Thao tác</th>
			</tr>
		</thead>
		<tbody>
			@foreach (var item in equipmentList)
			{
				<tr>
					<td>@item.IdProduct</td>
					<td>@item.Name</td>
					<td>@item.Unit</td>
					<td>@item.Quantity</td>
					<td>@item.Price.ToString("N0")</td>
					<td>
						<button class="btn btn-sm btn-primary"
								@onclick="() => AddItem(item.IdProduct, item.Name, item.Unit, item.Quantity, item.Price)">
							+
						</button>
					</td>
				</tr>
			}
		</tbody>
	</table>
</div>

<Toast @ref="toastComponent" />
@code {
	[Parameter] public int id { get; set; }
	private Toast toastComponent;
	private List<Equipments> equipmentList = new();
	private List<Equipments> equipmentOrderList = new();
	private List<OrderModel> orderInfor = new();
	private OrderModel order = new OrderModel
	{
		Status = "pending" 
	};
	private Dictionary<int, string> technicalDict = new();
	private Dictionary<int, (string, int)> serviceDict = new();
	private List<Users> customerList = new();


	bool isNew = true;
	int equipsPrice = 0;
	int servicePrice = 12;
	int totalprice = 0;
	int maxOrderid = 0;
	string keyword = "";
	bool isDisableButtonSubmit=true;

	private void Refreshform()
	{
		order.IdOrder = 0;
		order.IdCustomer = 0;
		order.Phone = "";
		order.Address = "";
		order.CustomerName = "";
		order.CreatedDate = null;           
		order.UpdatedDate = null;
		order.AppointmentTime = DateTime.Now;              
		order.Status = "pending";
		order.totalPrice = 0;
		order.ServiceId = 0;
		order.TechnicianId = 0;
		order.Items = new();
		equipmentOrderList = new();
		totalprice = 0;
		equipsPrice = 0;
		servicePrice = 0;
	}
	private async Task HandleValidSubmit()
	{


		order.totalPrice = equipsPrice + servicePrice;
		order.Items = equipmentOrderList;
		try
		{
			if (id != 0)
			{
				Console.WriteLine("Create 1");
				await orderDetailService.SaveOrderExamSync(order);
				toastComponent.ShowSuccess("Cập nhật phiếu thành công");
			}

			else if (id == 0)
			{
				Console.WriteLine("Create 2");
				await orderDetailService.CreateOrderExamSync(order);
				toastComponent.ShowSuccess("Tạo phiếu thành công");
				isDisableButtonSubmit = false;
				Refreshform();
			}


		}
		catch(Exception e)
		{
			toastComponent.ShowSuccess(e.ToString());
		}



	}

	protected override async Task OnInitializedAsync()
	{
		technicalDict = await orderDetailService.getTechnicalSelect();
		serviceDict = await orderDetailService.getServiceSelect();
		customerList = await orderDetailService.getCustomerAsync();
		maxOrderid = await orderDetailService.getMaxOrderId() + 1;
		await LoadEquipmentTable();

		var orders = await orderDetailService.getOrderAsync(id);
		if (orders.Any())
		{
			order = orders.First();
			equipmentOrderList = order.Items.ToList();
		}
		LoadTotalPrice();
	}
	private async Task LoadEquipmentTable()
	{
		equipmentList = await orderDetailService.getEquipmentAsync(keyword);
	}
	private void RemoveItem(int id)
	{
		try
		{
			var item = equipmentOrderList.FirstOrDefault(x => x.IdProduct == id);
			if (item != null)
			{
				equipmentOrderList.Remove(item);
				LoadTotalPrice();
			}
		}
		catch(Exception e)
		{
			Console.WriteLine("Loi" + e.ToString);
		}

	}


	private void AddItem(int id, string name, string unit, int quantity, int price)
	{
		var existing = equipmentOrderList.FirstOrDefault(x => x.IdProduct == id);
		if (existing != null)
			existing.Quantity += 1;

		else
		{
			equipmentOrderList.Add(new Equipments
			{
				IdProduct = id,
				Name = name,
				Unit = unit,
				Quantity = 1,
				Price = price
			});
		}

		LoadTotalPrice();
	}
	private void OnQuantityChanged(Equipments item, ChangeEventArgs e)
	{
		if (int.TryParse(e.Value?.ToString(), out int newQuantity))
			item.Quantity = newQuantity;
		LoadTotalPrice();


	}
	private void LoadTotalPrice()
	{
		equipsPrice = equipmentOrderList.Sum(x => x.Quantity * x.Price);

		if (order.ServiceId != 0 && serviceDict.ContainsKey(order.ServiceId))
			servicePrice = serviceDict[order.ServiceId].Item2;
		else
			servicePrice = 0;

		totalprice = equipsPrice + servicePrice;
	}
	private void cellClickTBCustomer(Users om)
	{
		order.IdCustomer = om.Id;
		order.CustomerName = om.Name;
		order.Phone = om.Phone;
		order.Address = om.Address;
		order.IdOrder = maxOrderid;
		isDisableButtonSubmit = true;

	}







}