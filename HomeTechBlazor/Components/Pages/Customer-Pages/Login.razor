@page "/login"
@rendermode InteractiveServer
@layout LandingLayout
@inject LoginService loginService
@inject NavigationManager NavigationManager
@inject CurrentUser CurrentUser

<HeadContent>
    <link href="css/login.css" rel="stylesheet" />
</HeadContent>

<div class="login-page">
    <div class="login-card">
        <div class="login-header">
            <h2>Đăng Nhập</h2>
            <p>Chào mừng quay lại với TECHFIX</p>
        </div>

        <EditForm Model="@loginModel" FormName="form_login" OnValidSubmit="OnValidSubmit" class="login-form">
            <DataAnnotationsValidator />

            <div class="form-group icon-input">
                <span class="icon">📱</span>
                <InputText @bind-Value="loginModel.Phone" placeholder="Số điện thoại" class="form-control" />
                <ValidationMessage For="@(() => loginModel.Phone)" />
            </div>

            <div class="form-group icon-input">
                <span class="icon">🔒</span>
                <InputText type="password" @bind-Value="loginModel.Password" placeholder="Mật khẩu" class="form-control" />
                <ValidationMessage For="@(() => loginModel.Password)" />
            </div>

            <button type="submit" class="btn-login">🚀 Đăng Nhập</button>
        </EditForm>

        <div class="register-link">
            <p>Chưa có tài khoản? <a href="/register">Đăng ký ngay</a></p>
        </div>
    </div>
</div>

<Toast @ref="toastComponent" />

@code {
    private Toast toastComponent;
    private HomeTechBlazor.Model.LoginModel loginModel = new();
    private void setCurrentUser(string role, string phone, string name, string address, string password)
    {
        CurrentUser.role = role;
        CurrentUser.phone = phone;
        CurrentUser.name = name;
        CurrentUser.address = address;
        CurrentUser.isLoggedIn = true;
        CurrentUser.password = password;
    }
    private async Task OnValidSubmit()
    {
        try
        {
            var json = await loginService.LoginAsync(loginModel.Phone, loginModel.Password);
            if (json == null) { toastComponent.ShowError("Sai tài khoản hoặc mật khẩu"); return; }
            var user = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, string>>(json)!;
            setCurrentUser(user["role"], user["phone"], user["name"], user["address"], user["dbPassword"]);
            NavigationManager.NavigateTo(user["role"] == "admin" ? "/home" : "/");
        }
        catch (Exception e)
        {
            toastComponent.ShowError(e.Message);
        }
    }
}
